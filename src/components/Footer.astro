---
const today = new Date();
---
<footer id="footer" role="contentinfo">
  
</footer><!-- end #footer -->
<style>
/* 弹窗基础样式 */
.popup-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  overflow: hidden;
  cursor: grab;
}
.popup-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
}
.post-content img, .comment-content img {
  max-width: 300px;
  cursor: zoom-in;
  transition: 0.2s;
}


#popupImage {
  width: auto;
  height: auto;
  transform: scale(1) translate(0, 0);
  transition: transform 0.3s ease;
  touch-action: none;
  user-select: none;
  will-change: transform;
}
@media (max-width: 767px) {
    .post-content img, .comment-content img {
        max-width: 200px;
        cursor: zoom-in;
        transition: 0.2s;
    }

  #popupImage {
    width: auto;
    height: auto;
    transform: scale(1) translate(0, 0);
    transition: transform 0.3s ease;
    touch-action: none;
    user-select: none;
    will-change: transform;
  }
}
</style>

<div class="popup-modal" id="popupModal">
  <img src="" id="popupImage" />
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const popup = document.getElementById("popupModal");
  const popupImg = document.getElementById("popupImage");

  let scale = 1;
  let posX = 0;
  let posY = 0;
  let startX, startY;
  let dragging = false;

  // 包裹文章和评论图片
  document.querySelectorAll('.post-content img, .comment-content img').forEach(img => {

    if (!img.closest('a')) {
      const link = document.createElement('a');
      link.href = img.src;
      link.className = 'popup-image';
      img.parentNode.insertBefore(link, img);
      link.appendChild(img);
    }
  });

  // 打开弹窗
  document.querySelectorAll('.popup-image').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      popupImg.src = link.href;
      popup.style.display = 'flex';
      resetImageTransform();
    });
  });

  // 点击背景关闭
  popup.addEventListener('click', e => {
    if (e.target === popup) {
      popup.style.display = 'none';
      popupImg.src = '';
    }
  });

  function resetImageTransform() {
    scale = 1;
    posX = 0;
    posY = 0;
    applyTransform();
  }

  function applyTransform() {
    popupImg.style.transform = `scale(${scale}) translate(${posX}px, ${posY}px)`;
  }

  // PC 拖拽
  popupImg.addEventListener('mousedown', e => {
    if (scale <= 1) return;
    e.preventDefault();
    dragging = true;
    startX = e.clientX - posX;
    startY = e.clientY - posY;
    popup.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', e => {
    if (dragging) {
      posX = e.clientX - startX;
      posY = e.clientY - startY;
      applyTransform();
    }
  });

  document.addEventListener('mouseup', () => {
    dragging = false;
    popup.style.cursor = 'grab';
  });

  // 移动端拖动 + 双指缩放
  let initialDistance = null;

  popupImg.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      initialDistance = getDistance(e.touches[0], e.touches[1]);
    } else if (e.touches.length === 1 && scale > 1) {
      startX = e.touches[0].clientX - posX;
      startY = e.touches[0].clientY - posY;
    }
  });

  popupImg.addEventListener('touchmove', e => {
    if (e.touches.length === 2 && initialDistance) {
      const newDistance = getDistance(e.touches[0], e.touches[1]);
      const newScale = (newDistance / initialDistance) * scale;
      scale = Math.min(Math.max(newScale, 1), 5);
      applyTransform();
    } else if (e.touches.length === 1 && scale > 1) {
      posX = e.touches[0].clientX - startX;
      posY = e.touches[0].clientY - startY;
      applyTransform();
    }
    e.preventDefault();
  });

  popupImg.addEventListener('touchend', e => {
    if (e.touches.length < 2) initialDistance = null;
  });

  function getDistance(touch1, touch2) {
    return Math.hypot(
      touch2.pageX - touch1.pageX,
      touch2.pageY - touch1.pageY
    );
  }
});
</script>
